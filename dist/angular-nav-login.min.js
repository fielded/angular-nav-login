!function(e){"use strict";function n(e,n){return n={exports:{}},e(n,n.exports),n.exports}e="default"in e?e.default:e;var t=function(e,n){if(!(e instanceof n))throw new TypeError("Cannot call a class as a function")},i=function(){function e(e,n){for(var t=0;t<n.length;t++){var i=n[t];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(n,t,i){return t&&e(n.prototype,t),i&&e(n,i),n}}(),r=function(){function e(n){t(this,e),this.loginService=n}return i(e,[{key:"$routerOnActivate",value:function(e){return this.loginService.login(e)}}]),e}();r.$inject=["loginService"];var s={controller:r},o=n(function(e,n){n.decodeBase64Url=function(e){return e.replace(/-/g,"+").replace(/_/g,"/").replace(/\./g,"=")},n.omit=function(e,n){return Object.keys(e).reduce(function(t,i){return n.indexOf(i)===-1&&(t[i]=e[i]),t},{})}}),a=o.omit,u=o.decodeBase64Url,c=function(){function e(n,i,r,s,o,a,u,c){t(this,e),this.$http=n,this.$window=i,this.$rootRouter=r,this.config=s,this.sessionService=o,this.toastService=a,this.mainService=u,this.userSessionService=c}return i(e,[{key:"createUser",value:function(e,n){var t={username:e,token:n},i={headers:{"x-api-key":this.config.middleware.key}};return this.$http.post(this.config.middleware.url+"/users",t,i)}},{key:"handleLoginError",value:function(e){var n="Could not log you in";return e&&e.data&&e.data.message&&(n+='. The response was "'+e.data.message+'".'),this.toastService.error("login-failed",n)}},{key:"init",value:function(e){return this.mainService.init(e),this.$rootRouter.navigate(["/Nav"]),e}},{key:"navLogin",value:function(){this.$window.location.href=this.config.nav+"/SignIn.aspx"}},{key:"navLogout",value:function(){this.$window.location.href=this.config.nav+"/SignOut.aspx"}},{key:"loginOrCreateUser",value:function(e,n){var t=this,i=function(){return t.createUser(e,n).then(function(){return t.sessionService.login(e,n)})};return this.sessionService.login(e,n).catch(i)}},{key:"canActivate",value:function(){var e=this,n=function(e,n){return n.ok?n.userCtx&&n.userCtx.name?e.userName?n.userCtx.name.toLowerCase()!==e.userName.toLowerCase()?Promise.reject("session mismatch for user "+e.userName):void 0:Promise.reject("missing user name in local session"):Promise.reject("missing user context in remote session"):Promise.reject("session invalid")},t=function(t){return e.sessionService.getSession().then(function(e){return n(t,e)}).then(function(){return e.init(t)}).catch(function(n){if(!e.$window.navigator.onLine)return e.init(t);throw n})};return this.userSessionService.getSession().then(function(e){return t(e)}).catch(function(n){return e.navLogin(n)})}},{key:"login",value:function(e){var n=this;if(!e.params.username||!e.params.token)return this.canActivate();var t=this.$window.decodeURI(e.params.username).toLowerCase(),i=u(e.params.token),r={lastLogin:(new Date).toISOString()};return this.loginOrCreateUser(t,i).then(function(){return n.sessionService.getUser(t)}).then(function(e){return n.userSessionService.updateRemoteSession(t,e,r)}).then(function(e){return n.userSessionService.setSession(e)}).then(function(e){return n.init(e)}).catch(function(e){return n.handleLoginError(e)})}},{key:"logout",value:function(){var e=this;return this.userSessionService.getSession().then(function(n){return e.sessionService.remove(n)})}}]),e}();c.$inject=["$http","$window","$rootRouter","config","sessionService","toastService","mainService","userSessionService"];var v=["_id","_rev","name","password","roles","type","salt","derived_key","password_scheme","iterations"],f=function(){function e(n){t(this,e),this.sessionService=n}return i(e,[{key:"updateRemoteSession",value:function(e,n,t){var i=a(n,v),r=Object.assign(i,t),s=function(e){return e.ok?Object.assign(r,a(e,["ok"])):n},o={metadata:r};return this.sessionService.putUser(e,o).then(s)}},{key:"getSession",value:function(){return this.sessionService.get("_local/session")}},{key:"setSession",value:function(e){var n=Object.assign({},e,{_id:"_local/session"}),t={forceUpdate:!0};return this.sessionService.save(n,t)}}]),e}();f.$inject=["sessionService"],e.module("angularNavLogin",[]).service("loginService",c).service("userSessionService",f).component("login",s)}(angular);